==title==
GrapQL subscriptions with Absinthe - testing basic subscriptions

==author==
Cornelia Kelinske

==description==
This is part 2 of a 3-part series on setting up and testing GraphQL subscriptions with Absinthe.

==tags==
coding, elixir, graphql, absinthe, subscriptions

==body==

# 1. Previously on this blog

In [part 1](https://connie.codes/post/graphql_subscription_setup) of this little series, we looked at how we can set up GraphQL subscriptions: the "vanilla" ones that are automatically triggered by a mutation as well as manually triggered subscriptions. In this post, we will write some tests for the former kind. Let's go!


# 2. The infrastructure 

First of all, let's have a quick look into our test folder:

```
├── test
│   ├── my_app
│   │   ├── some_other_test.exs
│   ├── my_app_web
│   │   ├── some_other_test.exs
│   │   ├── schema
│   │   │   ├── mutations
│   │   │   │   ├── some_mutation_test.exs
│   │   │   │   └── user_test.exs
│   │   │   ├── queries
│   │   │   │   ├── some_query_test.exs
│   │   │   │   └── user_test.exs
│   │   │   └── subscriptions
│   │   │       └── user_test.exs
│   │   └── views
│   │       └── error_view_test.exs
│   ├── support
│   │   ├── channel_case.ex
│   │   ├── conn_case.ex
│   │   ├── data_case.ex
│   │   ├── fixtures
│   │   │   └── user_fixtures.ex
│   │   └── subscription_case.ex
│   └── test_helper.exs
```

We see that, as per usual, the structure of our `test` folder mirrors the `lib` folder (shown in the previous post). 

In the `support` folder, we want to make sure that `@endpoint` in `channel_case.ex` is set correctly (it should be by default).
The `ChannelCase` module imports `Phoenix.ChannelTest` which provides the utility functions for pushing and receiving messages within `ExUnit`.

One file that is not autogenerated and that we need to add to the `support` folder is `subscription_case.ex`.
Here is what it looks like:

```elixir
defmodule MyAppWeb.SubscriptionCase do
  @moduledoc """
  This module defines the test case to be used by
  subscription tests.
  """
  use ExUnit.CaseTemplate
  alias Absinthe.Phoenix.SubscriptionTest
  alias Phoenix.ChannelTest

  using do
    quote do
      use MyAppWeb.ChannelCase
      use Absinthe.Phoenix.SubscriptionTest, schema: MyAppWeb.Schema

      setup do
        {:ok, socket} = ChannelTest.connect(MyAppWeb.UserSocket, %{})
        {:ok, socket} = SubscriptionTest.join_absinthe(socket)

        {:ok, %{socket: socket}}
      end
    end
  end
end
```

We can see that our `SubscriptionCase` uses both `ChannelCase` and `Absinthe.Phoenix.SubscriptionTest`. This allows us to push Absinthe docs up to Absinthe for Absinthe to reply. In the `setup` block - which, in this case, needs to be within the `use` block - we connect our `UserSocket` to a channel and subsequently set up Absinthe on that socket using `join_absinthe/1`. With our `SubscriptionCase` in place, we can now go ahead and write the tests.

# 3. The test

